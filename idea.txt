
class Styling {

    constructor(style, start, stop) {
        this.style = style;
        this.start = start;
        this.stop  = stop;
    }
}

class StyleBuilder {

    constructor(string) {
        this.original = string;
        this.edited   = string;
        this.list     = [];
    }

    addStyling(style, start, stop) {

        for (let i = 0; i < this.list.length; i++) {

            if (start < this.list[i].stop &&
                this.list[i].start < stop) {

                return;
            }
        }

        this.list.push(new Styling(style, start, stop));
    }

    splitStyling(style, start, stop, regex) {

        const segments = this.edited
            .substring(start, stop)
            .split(regex)
            .filter(function(s) { return s.length > 0; });

        stop = start;
        for (let i = 0; i < segments.length; i++) {

            start = this.edited.indexOf(segments[i], stop);
            stop  = start + segments[i].length;

            this.addStyling(style, start, stop);
        }
    }

    eraseRange(start, stop, begin = "", end = "") {

        this.edited =
            this.edited.substring(0, start) +
            begin +
            " ".repeat(stop - start - begin.length - end.length) +
            end +
            this.edited.substring(stop);
    }

    updateMatchedText(regex, style = "",
        split = null, begin = null, end = null) {

        for (let match = regex.exec(this.edited);
                 match !== null;
                 match = regex.exec(this.edited)) {

            const start = match.index;
            const stop  = start + match[0].length;

            if (style !== "") {

                if (split === null) {
                    this.addStyling(style, start, stop);
                } else {
                    this.splitStyling(style, start, stop, split);
                }
            }

            if (begin !== null) {
                this.eraseRange(start, stop, begin, end);
            }
        }
    }

    addCaptureGroups(match, styles) {

        for (let i = 0;
                 i < styles.length && i + 1 < match.length;
                 i++) {

            if (styles[i] !== "") {

                const start = match.index +
                              match[0].indexOf(match[i + 1]);

                this.addStyling(
                    styles[i],
                    start,
                    start + match[i + 1].length);
            }
        }
    }

    listUniqueMatches(match, groups) {

        for (let i = 0;
                 i < groups.length && i + 1 < match.length;
                 i++) {

            if (groups[i] !== null &&
                !groups[i].includes(match[i + 1])) {

                groups[i].push(match[i + 1]);
            }
        }
    }

    findCaptureGroups(regex, styles = null, groups = null) {

        for (let match = regex.exec(this.edited);
                 match !== null;
                 match = regex.exec(this.edited)) {

            if (styles !== null) {
                this.addCaptureGroups(match, styles);
            }

            if (groups !== null) {
                this.listUniqueMatches(match, groups);
            }
        }
    }
}
